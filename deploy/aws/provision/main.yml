#  Copyright 2018 Banco Bilbao Vizcaya Argentaria, S.A.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---
- hosts: localhost
  connection: local
  vars_files:
    - vars.yml
  environment:
    - GOOS: linux
    - GOARCH: amd64
    - GO111MODULE: 'on'
  tasks:
    - include: tasks/common/build.yml
    - include: tasks/common/config.yml

- hosts: all
  remote_user: ec2-user
  become: true
  tasks:
    - name: Wait 300 seconds for port 22 to become open and contain "OpenSSH"
      wait_for:
        port: 22
    - name: Gather facts
      setup:

- hosts: type_aws_instance
  remote_user: ec2-user
  become: true
  vars_files:
    - vars.yml
  tasks:
    - include: tasks/common/main.yml


- hosts: qed-server:qed-agent
  remote_user: ec2-user
  become: true
  vars_files:
    - vars.yml
  tasks:
    - include: tasks/qed/main.yml

- hosts: riot
  remote_user: ec2-user
  become: true
  vars_files:
    - vars.yml
  tasks:
    - include: tasks/riot/main.yml

- hosts: inmemory-storage
  remote_user: ec2-user
  become: true
  vars_files:
    - vars.yml
  tasks:
    - include: tasks/inmemory_storage/main.yml

- hosts: prometheus
  remote_user: ec2-user
  become: true
  vars_files:
    - vars.yml
  tasks:
    - include: tasks/prometheus/main.yml

- hosts: role_qed
  remote_user: ec2-user
  serial: 1
  become: true
  vars_files:
    - vars.yml
  tasks:
    - name: Start all services
      shell: >
        {{ item }}
      with_items:
        - /var/qed/qed-start.sh
        - /var/qed/exporter-start.sh
    - name: wait for raised api port
      wait_for:
        port: 8800
    - name: wait for raised mgmt port
      wait_for:
        port: 8700
    - name: wait for raised metrics port
      wait_for:
        port: 8600
    - name: wait for raised raft port
      wait_for:
        port: 8500

  tags:
    - start-qed

- hosts: role_auditor, role_monitor, role_publisher
  remote_user: ec2-user
  become: true
  vars_files:
    - vars.yml
  tasks:
    - name: Start all services
      shell: >
        {{ item }}
      with_items:
        - /var/qed/qed-start.sh
        - /var/qed/exporter-start.sh
  tags:
    - start-agents

- hosts: inmemory-storage
  remote_user: ec2-user
  become: true
  vars_files:
    - vars.yml
  tasks:
    - name: Start all services
      shell: > 
        {{ item }}
      with_items:
        - /var/qed/storage-start.sh
        - /var/qed/exporter-start.sh
  tags:
    - start-storage

- hosts: prometheus
  remote_user: ec2-user
  become: true
  vars_files:
    - vars.yml
  tasks:
    - name: Start all services
      shell: > 
        {{ item }}
      with_items:
        - /var/prometheus/prometheus-start.sh
        - /var/qed/exporter-start.sh
  tags:
    - start-prometheus

